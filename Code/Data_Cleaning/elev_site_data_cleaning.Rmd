---
title: "elev_site_data_cleaning"
author: "Ethan Abercrombie"
date: "`r Sys.Date()`"
output: html_document
---

# Packages

```{r packages, include=FALSE}
#packages
require(tidyverse)
require(reshape2)
require(sf)
require(betapart) #For beta-diversity measurements.
```

# Load Data

```{r load_data}
#sp_climate_data
#This file contains the climate preferences of each species. Generated through the file "ClimateNA_extraction.R".

sp_climate_data <- read_csv('~/Desktop/Grinnell-Mammal-Community-Shifts/Data/climate_data/species_climate_preferences.csv') %>% 
  mutate_at("species", str_replace_all, "_", "") %>% 
  mutate(species_name = str_replace(species,
                                    pattern = 'Peromyscusmaniculatussonoriensis',
                                    replacement = "Peromyscusmaniculatus"))

#Save species list
species_list <- unique(sp_climate_data$species)
```

# Species' elevational distribution data

Elevational distribution data were measured using probability of false absence (pfa) for contemporary and historical time periods.

```{r data, include=FALSE}
#load pfa data (probability of false absence). This data is used in Rowe et al. 2015.
pfa_data <- read_csv('/Users/ethanabercrombie/Library/CloudStorage/Box-Box/Grinnell-Mammal-Community-Shifts/Rowe et al. 2017 - FINAL Occupancy Analyses/PFA ANALYSES/WPFA_results_08Mar2011.csv') %>% 
  rename(transect_boundary = "...1") %>% #First object represents the transect (Lassen, Yosemite, Sequoi & Kings Canyon)
  filter(str_detect(transect_boundary,
                    '0') |
           str_detect(transect_boundary,
                      '1')) %>% #Filter data to select for species minimum and maximum elevation.
  mutate(Region = case_when(str_detect(transect_boundary,
                                         'SS') ~ 'SS',
                              str_detect(transect_boundary,
                                         'LA') ~ 'LA',
                              str_detect(transect_boundary,
                                         'YO') ~ 'YO'),
         Era = case_when(str_detect(transect_boundary,
                                    '0') ~ 'H',
                         str_detect(transect_boundary,
                                    '1') ~ 'M'),
         Marmotaflaviventris = c(1561,1971,
                                 1561,1971+520,
                                 2469,3353,
                                 2469,3353,
                                 2268,3503,
                                 2268,3503) ,
         Ochotonaprinceps = c(1478,2514,
                              1478,2514,
                              2377,3871,
                              2377,3871,
                              2732,3384,
                              2732,3384),
         Sciurusgriseus = c(103,1051,
                            103,1051+671,
                            183,1951,
                            183,1951-262,
                            787,2364,
                            787+720,2364-750),
         Tamiasciurusdouglasii = c(886,2061,
                                   886,2061+430,
                                   1229,3185,
                                   1229,3185,
                                   1592,3384,
                                   1592,3384),
         Thomomysbottae = c(75,1335,
                            75,1335,
                            57,1676,
                            57,1676,
                            118,3384,
                            118,3384),
         Thomomysmonticola = c(1561,2514,
                               1561,2514,
                               1905,3155,
                               1905,3155,
                               NA,NA,
                               NA,NA)) #Rename region and era columns. Add missing species elevational data as recorded in Rowe et al. 2015.

pfa_data <- pfa_data %>% 
  bind_rows(filter(pfa_data,
                   Era == 'M')) %>% 
  mutate(Era = if_else(duplicated(transect_boundary),
                       "HM",
                       Era))

pfa_data <- melt(pfa_data,
          id.vars = c('transect_boundary',
                      'Region',
                      'Era'),
          value.name = 'species_elevation',
          variable.name = 'species_name') %>% 
  group_by(Region,
           Era,
           species_name) %>% 
  mutate(species_min = min(species_elevation),
         species_max = max(species_elevation)) %>% 
  dplyr::select(-transect_boundary,
         -species_elevation) %>% 
  distinct()

#Save pfa_data
write_csv(pfa_data,
          file = "~/Desktop/Grinnell-Mammal-Community-Shifts/Data/pfa_data_clean.csv")

#pfa_data table
pfa_data_table <- pfa_data %>% 
  filter(Era == 'H' |
           Era == 'M') %>% 
  mutate(Era = case_when(Era == 'H' ~ "Historical",
                          Era == 'M' ~ "Modern")) %>% 
  pivot_wider(names_from = Region,
              values_from = c(species_min,
                              species_max)) %>% 
  mutate(Lassen = paste(species_min_LA,
                         species_max_LA,
                         sep = '-'),
         Yosemite = paste(species_min_YO,
                         species_max_YO,
                         sep = '-'),
         Sequoia = paste(species_min_SS,
                         species_max_SS,
                         sep = '-')) %>% 
  select(Era,
         species_name,
         Lassen,
         Yosemite,
         Sequoia)

write_csv(pfa_data_table,
          file = '~/Desktop/Grinnell-Mammal-Community-Shifts/Manuscript/table_exports/species_elevation_table.csv')
```

# Site Data

```{r data, include=FALSE}
#load site data. Filter to exclude species and psi columns

# Commented read_csv below uses aggregate sites.
# site_data_ <- read_csv('/Users/ethanabercrombie/Library/CloudStorage/Box-Box/Grinnell-Mammal-Community-Shifts/Rowe et al. 2017 - FINAL Occupancy Analyses/R Scripts and Mark Data/PSI-by-Site-08mar2011.csv') %>% 
#   rename(site_name = AggregateName) %>%
#   distinct(site_name,
#            .keep_all = T) #This results in a single copy of site information. .keep all argument keeps all columns.

# This code uses all original Grinnell sites.
site_data_ <- readxl::read_excel('/Users/ethanabercrombie/Desktop/Grinnell-Mammal-Community-Shifts/Data/site_data/allregionslocalitiestoaggswithelev08Mar2011.xlsx')

site_data_ <- site_data_ %>%
  rename(Era = era,
         Region = region,
         site_name = aggname) %>% 
  filter(Era == 'H') %>% 
  select(-speclocality, 
         -loclat,
         -loclong,
         -locelevm) %>% 
  distinct() %>% 
  mutate(aggelev = round(aggelev))

site_data <-  site_data_ %>% 
  bind_rows(site_data_) %>% 
  mutate(Era = if_else(duplicated(site_name),
                       "HM",
                       Era)) #Make duplicates of historical site, and rename Era to "HM". This will be used to calculate contemporary CCIs for historical sites. We must use the position of historical sites because historical and modern sites are not at the same location.


# Not needed since using new data.

# #Add elevation data from PRISM rasters. PRISM data is used because ClimateNA relies on PRISM data. Lassen historical site elevation in site_data recorded inaccurately -- using PRISM elevation fixes this issue.
# prism_elev_data <- terra::rast("/Users/ethanabercrombie/Desktop/Grinnell-Mammal-Community-Shifts/Data/Geospatial Data/PRISM_us_dem_800m.tif")
# 
#   site_data_sf <- site_data %>% 
#     st_as_sf(coords = c('longitude',
#                         'latitude'),
#              crs = st_crs("EPSG:4269"))
#   
#   site_data <- site_data %>% 
#     mutate(Elev_prism = raster::extract(prism_elev_data,
#                        y = site_data_sf)[,2])
```

## Community Climate Indeces

Calculate community climate indices and save to site_data.

```{r data, include=FALSE}
#Calculate the community precipitation and community temperature index.
#For loop for every site CCI
for (i in 1:nrow(site_data)) {
  print(i)
  #Create a temporary object that is the filtered results of pfa_data (elevational distributions) that matches the Region and Era for each site. These distributions are used to determine which species are present at each site.
  pfa_loop <- pfa_data %>% 
    filter(Region %in% site_data[i,] &
             Era %in% site_data[i,])
  
  #Assign a value of 1 (present) to species within the elevation range defined in 'pfa_data'
  for (sp in unique(species_list)) {
    #print(sp)
    pfa_loop_2 <- pfa_loop %>% 
    filter(species_name == sp)
    site_data[i,sp] <- case_when(site_data[i, 'aggelev'] >= pfa_loop_2$species_min &
                                      site_data[i, 'aggelev'] <= pfa_loop_2$species_max ~ 1,
                                      site_data[i, 'aggelev'] < pfa_loop_2$species_min ~ 0,
                                      site_data[i, 'aggelev'] > pfa_loop_2$species_max ~ 0)
  }
  
}

#Community climate affinities 
community_data <- site_data %>% 
  select(any_of(sp_climate_data$species_name)) %>% 
  t() 

colnames(community_data) <- site_data$site_name
  
  #Community temperature index
  community_data_MAT <- community_data * sp_climate_data$MAT
  community_data_MAT[community_data_MAT == 0] <- NA
  
  community_data_MAT <- community_data_MAT %>% 
    t() %>% 
    as.data.frame() %>% 
    rowwise() %>% 
    mutate(CTI = mean(c_across(everything()),
                           na.rm = T))
  
  community_data_MAT <- as.data.frame(community_data_MAT) %>% 
    mutate(site_name = site_data$site_name,
           Era = site_data$Era) %>% 
    select(site_name,
           Era,
           CTI)
  
  #Community precipitation index
  community_data_MAP <- community_data * sp_climate_data$MAP
  community_data_MAP[community_data_MAP == 0] <- NA
  
  community_data_MAP <- community_data_MAP %>% 
    t() %>% 
    as.data.frame() %>% 
    rowwise() %>% 
    mutate(CPI = mean(c_across(everything()),
                           na.rm = T))
  
  community_data_MAP <- as.data.frame(community_data_MAP) %>% 
    mutate(site_name = site_data$site_name,
           Era = site_data$Era) %>% 
    select(site_name,
           Era,
           CPI)

  #Add community climate indices to site_data
  site_data <- left_join(x = site_data,
                 y = community_data_MAT,
                 by = c('site_name',
                        'Era')) %>% 
    left_join(y = community_data_MAP,
              by = c('site_name',
                        'Era')) %>% 
    relocate(c(CTI,CPI),
             .after = site_name)
  
  site_data <- site_data %>% 
    group_by(site_name) %>% 
    mutate(cti_change = diff(CTI),
           cpi_change = diff(CPI)) %>% 
    ungroup() %>% 
    relocate(cti_change,
             .after = CTI) %>% 
    relocate(cpi_change,
             .after = CPI)
  
  nrow(site_data)
  # Remove sites with cti_change/cpi_change == 0. This occurs at high elevations with no species present. Should result in 2 sites removed, both historical and modern (need comparisons). nrow(site_data shoudl read 4 less than above.)
  site_data <- filter(site_data,
                      !is.na(cti_change))
  nrow(site_data)
  
# ----------------------------------------------------------
# Decompose CTI/CPI change into extinction vs. colonization
# and split by adaptation. Outputs are added to `site_data`.
# ----------------------------------------------------------

# -- Traits lookup (only what we need)
species_traits <- sp_climate_data %>%
  select(
    species_name, MAT, MAP,
    temperature_adaptation,   # "cool-adapted" / "warm-adapted"
    precipitation_adaptation  # "dry-adapted"  / "wet-adapted"
  )

# -- Long site × species presence with traits
site_species_long <- site_data %>%
  select(site_name, Era, any_of(species_list)) %>%
  pivot_longer(
    cols = all_of(species_list),
    names_to = "species_name",
    values_to = "presence"
  ) %>%
  left_join(species_traits, by = "species_name")

# -- Put Historical (H) and Modern (HM) presence side-by-side
site_species_split <- site_species_long %>%
  pivot_wider(
    names_from  = Era,
    values_from = presence,
    values_fill = 0
  ) %>%
  mutate(
    status = case_when(
      H  == 1 & HM == 0 ~ "extinction",
      H  == 0 & HM == 1 ~ "colonization",
      H  == 1 & HM == 1 ~ "persistence",
      TRUE              ~ "absent"
    )
  )

# -- Safe mean: return NA_real_ if no values
s_mean <- function(x) {
  x <- x[!is.na(x)]
  if (length(x) == 0) NA_real_ else mean(x)
}

# -- Per-site decomposition function
compute_site_contrib <- function(df_site) {
  # Logical membership for Historical / Persisters / Modern
  H_idx  <- df_site$H  == 1
  HM_idx <- df_site$HM == 1
  P_idx  <- df_site$H  == 1 & df_site$HM == 1   # persisters

  # Vectors
  mat <- df_site$MAT
  map <- df_site$MAP
  t_adapt <- df_site$temperature_adaptation
  p_adapt <- df_site$precipitation_adaptation
  stat    <- df_site$status

  # -- Baseline means
  CTI_H  <- s_mean(mat[H_idx])
  CTI_P  <- s_mean(mat[P_idx])
  CTI_HM <- s_mean(mat[HM_idx])

  CPI_H  <- s_mean(map[H_idx])
  CPI_P  <- s_mean(map[P_idx])
  CPI_HM <- s_mean(map[HM_idx])

  # -- Sequential contributions
  cti_temp_extinction   <- CTI_P  - CTI_H
  cti_temp_colonization <- CTI_HM - CTI_P

  cpi_precip_extinction   <- CPI_P  - CPI_H
  cpi_precip_colonization <- CPI_HM - CPI_P

  # ---------- CTI split (warm vs. cool) ----------
  ext_warm_idx <- H_idx  & !HM_idx & t_adapt == "warm-adapted"
  ext_cool_idx <- H_idx  & !HM_idx & t_adapt == "cool-adapted"

  CTI_minus_warm_ext <- s_mean(mat[ H_idx & !ext_warm_idx ])
  CTI_minus_cool_ext <- s_mean(mat[ H_idx & !ext_cool_idx ])

  cti_temp_extinction_warm <- CTI_minus_warm_ext - CTI_H
  cti_temp_extinction_cool <- CTI_minus_cool_ext - CTI_H

  col_warm_idx <- !H_idx & HM_idx & t_adapt == "warm-adapted"
  col_cool_idx <- !H_idx & HM_idx & t_adapt == "cool-adapted"

  CTI_plus_warm_col <- s_mean(mat[ P_idx | col_warm_idx ])
  CTI_plus_cool_col <- s_mean(mat[ P_idx | col_cool_idx ])

  cti_temp_colonization_warm <- CTI_plus_warm_col - CTI_P
  cti_temp_colonization_cool <- CTI_plus_cool_col - CTI_P

  # ---------- CPI split (wet vs. dry) ----------
  ext_wet_idx <- H_idx  & !HM_idx & p_adapt == "wet-adapted"
  ext_dry_idx <- H_idx  & !HM_idx & p_adapt == "dry-adapted"

  CPI_minus_wet_ext <- s_mean(map[ H_idx & !ext_wet_idx ])
  CPI_minus_dry_ext <- s_mean(map[ H_idx & !ext_dry_idx ])

  cpi_precip_extinction_wet <- CPI_minus_wet_ext - CPI_H
  cpi_precip_extinction_dry <- CPI_minus_dry_ext - CPI_H

  col_wet_idx <- !H_idx & HM_idx & p_adapt == "wet-adapted"
  col_dry_idx <- !H_idx & HM_idx & p_adapt == "dry-adapted"

  CPI_plus_wet_col <- s_mean(map[ P_idx | col_wet_idx ])
  CPI_plus_dry_col <- s_mean(map[ P_idx | col_dry_idx ])

  cpi_precip_colonization_wet <- CPI_plus_wet_col - CPI_P
  cpi_precip_colonization_dry <- CPI_plus_dry_col - CPI_P

  tibble::tibble(
    cti_temp_extinction,
    cti_temp_colonization,
    cti_temp_extinction_warm,
    cti_temp_extinction_cool,
    cti_temp_colonization_warm,
    cti_temp_colonization_cool,
    cpi_precip_extinction,
    cpi_precip_colonization,
    cpi_precip_extinction_wet,
    cpi_precip_extinction_dry,
    cpi_precip_colonization_wet,
    cpi_precip_colonization_dry
  )
}

# -- Compute one row of contributions per site_name
site_contrib <- site_species_split %>%
  group_by(site_name) %>%
  group_modify(~ compute_site_contrib(.x)) %>%
  ungroup()

# -- Join back to site_data
site_data <- site_data %>%
  left_join(site_contrib, by = "site_name")

# Optional: if you prefer contributions only on HM rows and NA on H:
# site_data <- site_data %>%
#   mutate(across(
#     c(cti_temp_extinction:cpi_precip_colonization_dry),
#     ~ if_else(Era == "HM", .x, NA_real_)
#   ))

site_data <- site_data %>%
  mutate(across(
    c(cti_temp_extinction:cpi_precip_colonization_dry),
    ~ case_when(
      Region == "LA" ~ .x / 80,   # 80 years → 8 decades
      Region == "YO" ~ .x / 85,
      Region == "SS" ~ .x / 94,
      TRUE ~ .x
    )
  ))
  
```


Save site information in a way to be used in ClimateNA so we understand how climate has changed at each site.

```{r data, include=FALSE}
# #Save site_data in csv compatible with climate NA to extract climate data.
#   site_data_climateNA <- site_data %>%
#     select(site_name,
#            Era,
#            agglat,
#            agglong,
#            aggelev) %>%
#     transmute(ID1 = site_name,
#               ID2= Era,
#               lat = agglat,
#               long = agglong,
#               el = aggelev)
# 
#   write.csv(site_data_climateNA,
#             file = "~/Desktop/Grinnell-Mammal-Community-Shifts/Data/climate_datasite_data_climateNA_extraction.csv",
#             fileEncoding = 'UTF-8',
#             row.names = FALSE)
#   
# # Define your output directory
# out_dir <- '/Users/ethanabercrombie/Desktop/Grinnell-Mammal-Community-Shifts/Data/climate_data/'
# 
# # Initialize an empty data frame to store the results
# combined_data <- data.frame()
# 
# # Iterate over the period list from 1901 to 2021
# for (year in 1901:2021) {
#   # Run the ClimateNAr function for the current year
#   result <- ClimateNAr::climateNAr(inputFile = "~/Desktop/Grinnell-Mammal-Community-Shifts/Data/climate_datasite_data_climateNA_extraction.csv",
#                        periodList = year,  # Running for one year at a time
#                        varList = c('MAT', 'MAP'),
#                        outDir = out_dir)  # Saving to the directory (though you can remove this if you only want the combined file)
#   
#   # Add the current year as a new column
#   result$Year <- year
#   
#   # Combine the result with the previous years' data
#   combined_data <- rbind(combined_data, result)
# }
# 
# 
# # Save the final combined data frame to a CSV file
# write.csv(combined_data, file = file.path("~/Desktop/Grinnell-Mammal-Community-Shifts/Data/climate_data/site_data_climateNA_extraction_1901-2021Y.csv"), row.names = FALSE)

site_data_climate <- read_csv("/Users/ethanabercrombie/Library/CloudStorage/Box-Box/Grinnell-Mammal-Community-Shifts/site_data_climateNA_extraction_1901-2021Y.csv")

names(site_data_climate)[1] = "site_name"
names(site_data_climate)[2] = "Era"

site_data_climate <- merge(site_data_climate,
      site_data[,c('Region','site_name')],
      by = c('site_name')) %>% #Add Region info so we can filter each region by corresponding year range.
  distinct()

# Years pulled from Grinnell Resurvey Project Website.
  
site_data_climate <- site_data_climate %>% 
  mutate(year_lower = case_when(Region == 'LA' & Era == 'H' ~ (1929-15),
                                Region == 'YO' & Era == 'H' ~ (1920-15),
                                Region == 'SS' & Era == 'H' ~ (1916-15),
                                Region == 'LA' & Era == 'HM' ~ (2009-15),
                                Region == 'YO' & Era == 'HM' ~ (2005-15),
                                Region == 'SS' & Era == 'HM' ~ (2010-15)),
         year_upper = case_when(Region == 'LA' & Era == 'H' ~ (1929),
                                Region == 'YO' & Era == 'H' ~ (1920),
                                Region == 'SS' & Era == 'H' ~ (1916),
                                Region == 'LA' & Era == 'HM' ~ (2009),
                                Region == 'YO' & Era == 'HM' ~ (2005),
                                Region == 'SS' & Era == 'HM' ~ (2010)))

site_data_climate <- site_data_climate %>% 
  group_by(site_name,
           Era) %>%
  filter(Year >= year_lower & Year <= year_upper) %>% 
  summarise(temp = median(MAT),
            precip = median(MAP))

# site_data_climate_H <- site_data_climate %>% 
#   filter(Era == 'H',
#          Year <= 1931) %>% 
#   group_by(site_name) %>% 
#   summarise(temp = median(MAT),
#             precip = median(MAP)) %>% 
#   mutate(Era = "H")
# 
# site_data_climate_M <- site_data_climate %>% 
#   filter(Era == 'HM',
#          Year >= 1991) %>% 
#   group_by(site_name) %>% 
#   summarise(temp = median(MAT),
#             precip = median(MAP)) %>% 
#   mutate(Era = "HM")

# site_data <- site_data %>% 
#   left_join(site_data_climate_H,
#             by = c("site_name",
#                    "Era")) %>% 
#   rows_update(site_data_climate_M,
#               by = c("site_name",
#                    "Era")) %>% 
#   group_by(site_name) %>%
#   mutate(temp_change = diff(temp),
#          precip_change = diff(precip)) %>% 
#   relocate(c(temp,
#              temp_change),
#            .before = CTI) %>% 
#   relocate(c(precip,
#              precip_change),
#            .before = CPI)

site_data <- site_data %>% 
  left_join(site_data_climate,
            by = c("site_name",
                   "Era")) %>% 
  group_by(site_name) %>%
  mutate(temp_change = diff(temp),
         precip_change = diff(precip)) %>% 
  relocate(c(temp,
             temp_change),
           .before = CTI) %>% 
  relocate(c(precip,
             precip_change),
           .before = CPI)
```

Calculate Thermophilization & Mesophilization Rates

Lassen -- originally sampled 1924-1929, resurveyed 2006-2009, duration (1929-2009) = 80 years

Yosemite -- originally sampled 1914-1920, resurveyed [not mentioned, believe 2005], duration (1920-2005) = 85 years

Sequoia -- originally sampled 1911-1916, resurveyed 2008-2010, duration (1916-2010) = 94 years

```{r}
site_data <- site_data %>% 
  mutate(cti_rate = case_when(Region == 'LA' ~ cti_change/80,
                                Region == 'YO' ~ cti_change/85,
                                Region == 'SS' ~ cti_change/94),
         cpi_rate = case_when(Region == 'LA' ~ cpi_change/80,
                                Region == 'YO' ~ cpi_change/85,
                                Region == 'SS' ~ cpi_change/94),
         temp_rate = case_when(Region == 'LA' ~ temp_change/80,
                                Region == 'YO' ~ temp_change/85,
                                Region == 'SS' ~ temp_change/94),
         precip_rate = case_when(Region == 'LA' ~ precip_change/80,
                                Region == 'YO' ~ precip_change/85,
                                Region == 'SS' ~ precip_change/94)) %>% 
  relocate(cti_rate,
           .after = cti_change) %>% 
  relocate(cpi_rate,
           .after = cpi_change)
```

Save file.

```{r data, include=FALSE}
#Save site_data
  write_csv(site_data,
          file = "~/Desktop/Grinnell-Mammal-Community-Shifts/Data/site_data_clean.csv")

#Load data
site_data <- read_csv('~/Desktop/Grinnell-Mammal-Community-Shifts/Data/site_data_clean.csv')
```
