---
title: "Untitled"
author: "Ethan Aberccrombie"
date: "7/29/2021"
output: html_document
---
This code is borrowed and inspired from Adam Smith and the "Best Practices in Species Distribution Modeling" Workshop series.

http://www.earthskysea.org/best-practices-in-species-distribution-modeling-a-workshop-in-r/

A few resources:
-http://mazamascience.com/WorkingWithData/?p=1494
-https://www.r-bloggers.com/2019/04/zooming-in-on-maps-with-sf-and-ggplot2/

https://r-spatial.org/r/2018/10/25/ggplot2-sf.html

https://stackoverflow.com/questions/50144222/how-to-mark-points-by-whether-or-not-they-are-within-a-polygon

```{r, include=FALSE}
#load packages
library(tidyverse)
  #spatial data packages
#library(dismo)
#library(raster)
library(sf)
require(terra)
  #ggplot functions
library(viridis)

require(rnaturalearth)
require(units)

#increase memory (up to 3gb on Windows 64 bit)
memory.limit(memory.limit() * 2^30)
```


```{r, include=FALSE}
#load occurrence data
species <- read.delim('C:/Grinnell-Mammal-Community-Shifts/Data/Species Occurrence Data/Callospermophilus_lateralis/GBIF/occurrence.txt')

#R does not know how to interpret the first column.
#Change the first column to a character.
species$gbifID <- as.character(species$gbifID)

#structure of data frame
str(species)

#observation types
unique(species$type)
  #take a subset of the data.
  #We are assuming these 'types' of data represent real collections, collected by professionals.
  species <- subset(species,
    type=='PhysicalObject' |
    type=='specimen' |
    type=='PRESERVED_SPECIMEN' |
    type=='PreservedSpecimen' |
    type=='Occurrence' |
    type=="Collection"
  )

```

```{r, include=FALSE}
### convert species data to a spatial object for plotting

	# assuming your data frame with species data (with coordinates) is called "species"
	# also assuming columns for longitude/latitude are the names in GBIF ("decimalLongitude", "decimalLatitude")
	
	ll <- c('decimalLongitude', 'decimalLatitude')
	
	# "proj4" string for the coordinate reference system used by GBIF (WGS84)
	wgs84 <- '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84'
	
	# remove records with no long/lat
	speciesNoNas <- species[complete.cases(species[ , ll]) , ]
	
	# convert to a "shapefile"... may give a warning about the coordinate reference system, but it's OK
#	speciesSp <- SpatialPointsDataFrames(coords=speciesNoNas[ , ll], data=speciesNoNas, proj4string=CRS(wgs84))

#Trying to convert to sf shapefile	
speciesSf <- st_as_sf(x = speciesNoNas,
                      coords = c(x = 'decimalLongitude',
                                 y = 'decimalLatitude'),
                      crs = 4326)
```

```{r, include=FALSE}
### get outlines of states/counties of Canada, US, Mexico

load('C:/Grinnell-Mammal-Community-Shifts/Code/Occurence Data Cleaning/GADM Canada, USA, Mexico Level 0 WGS84.rda')
load('C:/Grinnell-Mammal-Community-Shifts/Code/Occurence Data Cleaning/GADM Canada, USA, Mexico Level 1 WGS84.rda')
load('C:/Grinnell-Mammal-Community-Shifts/Code/Occurence Data Cleaning/GADM Canada, USA, Mexico Level 2 WGS84.rda')

	# remove Alaska and Hawaii because they make plotting much slower... but you may want to include Alaska if any species reside there
	states <- nam1Sp[!(nam1Sp@data$NAME_1 %in% c('Hawaii', 'Alaska')), ]
	  states <- st_as_sf(states)
	counties <- nam2Sp[!(nam2Sp@data$NAME_1 %in% c('Hawaii', 'Alaska')), ]
	  counties <- st_as_sf(counties)
```

```{r}
#load rangemap
rangeMap <- st_read('C:/Grinnell-Mammal-Community-Shifts/Data/IUCN Species Ranges/Species Ranges_Exports_QGIS/Callospermophilus_lateralis/Callospermophilus_lateralis.shp')

default_crs = sf::st_crs(4326)
```

# Mapping

Map of all Observations

```{r}
#All observations.
ggplot() +
  geom_sf(data = states) +
  geom_sf(data = speciesSf, 
             aes(color = coordinateUncertaintyInMeters)) +
  scale_colour_viridis(option = "magma")
```

There are several concerning records. One is in the ocean, the others in Mexico -- The species range does not typically include this location. 

Before manually removing these records, let's apply a few filters.

Filter data. Remove all occurences with uncertaintity > 1000m. Remove all occurences collected before 1970.

```{r}
# Because climate is constantly changing, we need to limit our references to those collections in recent years.
# Let's start by limiting our collection to years 1970-2000
hist(species$year,
    xlab='Collection year',
    ylab='Number of records',
    main='Collection year (all years)'
)
#Considering climate changes rapidly in montane environments, I am going to remove occurence that have uncertainty greater than 1000m.
speciesSf_filtered <- speciesSf %>% 
  filter(year >= 1970) %>% 
  filter(coordinateUncertaintyInMeters <= 1000 | is.na(coordinateUncertaintyInMeters))
```

Plot occurences after filtering.

```{r}
#map the occurences again
#All of North America.
ggplot() +
  geom_sf(data = states) +
  geom_sf(data = speciesSf_filtered, 
             aes(color = coordinateUncertaintyInMeters)) +
  scale_colour_viridis(option = "magma")
```

Crop into the appropriate region. Add county and state borders.

We would like to remove points with no coordinate uncertainty that fall outside of the IUCN rangemap.

```{r}
#Let's zoom in. Here we are "zooming" in and not "cropping" the data. The geoms are not manipulated. See resources for more information.
speciesSf_filtered <- speciesSf_filtered %>% 
  mutate(within_range = lengths(st_within(x = speciesSf_filtered, 
                                          y = rangeMap)))

#Plot
ggplot() +
  geom_sf(data = counties,
          fill = NA) +
  geom_sf(data = states,
               fill = NA,
               color = "darkred") +
  geom_sf(data = rangeMap,
          color = 'darkgreen',
          fill = 'green',
          alpha = 0.5,
          inherit.aes = FALSE) +
  geom_sf(data = speciesSf_filtered, 
             aes(color = within_range),
          inherit.aes = FALSE) +
  coord_sf(xlim = c(-125, -100), 
           ylim = c(32, 55), 
           expand = TRUE)
```

Add an 80 km buffer.

```{r}
# buffer size 
buffer_distance <- as_units(80, "km")
range_buffer <- rangeMap %>% 
  st_buffer(dist = buffer_distance)

speciesSf_filtered <- speciesSf_filtered %>% 
  mutate(within_range = lengths(st_within(x = speciesSf_filtered, 
                                          y = range_buffer)))

ggplot() +
  geom_sf(data = counties,
          fill = NA) +
  geom_sf(data = states,
               fill = NA,
               color = "darkred") +
  geom_sf(data = range_buffer,
          color = 'goldenrod3',
          fill = 'yellow',
          alpha = 0.3,
          inherit.aes = FALSE) +
  geom_sf(data = rangeMap,
          color = 'darkgreen',
          fill = 'green',
          alpha = 0.5,
          inherit.aes = FALSE) +
  geom_sf(data = speciesSf_filtered, 
             aes(color = within_range),
          inherit.aes = FALSE) +
  coord_sf(xlim = c(-125, -100), 
           ylim = c(32, 55), 
           expand = TRUE)
```

After points with no coordinate uncertainty that fall outside of the IUCN rangemap (including buffer) are removed.

```{r}
speciesSf_filtered <- speciesSf_filtered %>% 
  mutate(within_range = lengths(st_within(x = speciesSf_filtered, 
                                          y = range_buffer))) %>% 
  filter(!(coordinateUncertaintyInMeters != "NA" &
           within_range == 0))

#Plot
ggplot() +
  geom_sf(data = counties,
          fill = NA) +
  geom_sf(data = states,
               fill = NA,
               color = "darkred") +
  geom_sf(data = range_buffer,
          color = 'goldenrod3',
          fill = 'yellow',
          alpha = 0.3,
          inherit.aes = FALSE) +
  geom_sf(data = rangeMap,
          color = 'darkgreen',
          fill = 'green',
          alpha = 0.5,
          inherit.aes = FALSE) +
  geom_sf(data = speciesSf_filtered, 
             aes(color = within_range),
          inherit.aes = FALSE) +
  coord_sf(xlim = c(-125, -100), 
           ylim = c(32, 55), 
           expand = TRUE)
```

Other issues.

We will remove the single value containing the "COORDINATE_PRECISION_INVALID" warning.
We will also remove the records containing the "COORDINATE_ROUNDED" warning.

```{r}
unique(speciesSf_filtered$issue)

#Evaluate the number of observations with rounded coordinates
fi <- filter(speciesSf_filtered,
            grepl(c('COORDINATE_ROUNDED'),
                  issue
            ))
fi$gbifID

fi <- filter(speciesSf_filtered,
            grepl(c('COORDINATE_PRECISION_INVALID'),
                  issue
            ))
fi$gbifID

#We will remove the single value containing the "COORDINATE_PRECISION_INVALID" warning.
#We will also remove the records containing the "COORDINATE_ROUNDED" warning. 

  #Remove these records
speciesSf_filtered <- speciesSf_filtered %>% 
  filter(!(grepl('COORDINATE_ROUNDED',
               issue)) |
           grepl('COORDINATE_PRECISION_INVALID',
                 issue))
```

## Climate Data

```{r}
# # #Note: the raster function was previously used to download WorldClim data. getData() might need to be used to download approporiate data for other species.
# # require(WorldClimTiles)
# 
# #Download Data for the United States.
# #Tiles 11 and 12 cover the range of this species.
# worldclim_tiles <- tile_get(c(11,12), "bio")
# 
# #merge tiles
# climate_data <- tile_merge(worldclim_tiles)
# 
# #save climate_data for faster knitting.
# save(climate_data,
#       file = "climate_data.RData")
# 
# writeRaster(climate_data,
#             "climate_data",
#             format = 'GTiff',
#             overwrite = T)

climate_data <- stack('C:/Grinnell-Mammal-Community-Shifts/Code/Occurence Data Cleaning/climate_data.tif')
```

Remove those occurrences within outside of the 95th percentile

```{r}
ggplot() +
  geom_sf(data = counties,
          fill = NA) +
  geom_sf(data = states,
               fill = NA,
               color = "darkred") +
  geom_sf(data = rangeMap,
          color = 'darkgreen',
          fill = 'green',
          alpha = 0.5,
          inherit.aes = FALSE) +
  geom_sf(data = speciesSf_filtered, 
          inherit.aes = FALSE) +
  coord_sf(xlim = c(-125, -100), 
           ylim = c(32, 55), 
           expand = TRUE) 
```

```{r}
#Extract values from points.
#Goal: keep all points within 95% of the climate range.
speciesSf_filtered <- raster::extract(climate_data,
                speciesSf_filtered,
                sp = TRUE)

speciesSf_filtered <- st_as_sf(speciesSf_filtered) %>% 
  mutate(Annual_Temp = bio1 / 10,
         Annual_Precip = bio12 / 1000) %>% 
  filter(Annual_Temp <= quantile(Annual_Temp, 0.95) &
           Annual_Precip <= quantile(Annual_Precip, 0.95))
```

# Final Plot

This plot illustrates those occurences that will be used to determine the climatic preference of the species.

```{r}
ggplot() +
  geom_sf(data = states,
               fill = NA,
               color = "darkred") +
  geom_sf(data = rangeMap,
          color = 'darkgreen',
          fill = 'green',
          alpha = 0.5,
          inherit.aes = FALSE) +
  geom_sf(data = speciesSf_filtered, 
             aes(color = Annual_Temp),
          inherit.aes = FALSE) +
  coord_sf(xlim = c(-125, -100), 
           ylim = c(32, 55), 
           expand = TRUE) 
```

